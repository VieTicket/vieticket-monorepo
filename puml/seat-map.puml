@startuml view-own-seatmaps
autonumber
!theme plain
title View Own Seat Maps Flow

actor Organizer
participant "Seat Map Directory Page\n(UI Components)" as Page
participant "API Actions" as Actions
participant "Auth Service" as Auth
participant "SeatMap Service" as Service
participant "SeatMap Repository" as Repo
participant "MongoDB" as MongoDB

== Initial Load ==
Organizer -> Page: Navigate to /organizer/seat-map
activate Page

Page -> Actions: getUserSeatMapsAction()
activate Actions

Actions -> Auth: getAuthSession()
activate Auth
Auth --> Actions: Session with user data
deactivate Auth

alt User not authenticated
    Actions --> Page: { success: false, error: "Unauthenticated" }
    Page -> Organizer: Show error message
else User authenticated
    Actions -> Service: getUserSeatMaps(user)
    activate Service
    
    Service -> Repo: findSeatMapsByCreator(userId)
    activate Repo
    Repo -> MongoDB: Query seat maps by createdBy
    activate MongoDB
    MongoDB --> Repo: User's seat maps array
    deactivate MongoDB
    Repo --> Service: Seat maps list
    deactivate Repo
    
    Service --> Actions: Seat maps with metadata
    deactivate Service
    
    Actions --> Page: { success: true, data: seatMaps[] }
    deactivate Actions
end

Page -> Organizer: Display seat maps in grid/list view
Page -> Organizer: Show sidebar with recent updates

== Search Functionality ==
Organizer -> Page: Type in search box
Page -> Actions: searchSeatMapsAction(query)
activate Actions

Actions -> Auth: getAuthSession()
Auth --> Actions: User session

Actions -> Service: searchUserSeatMaps(query, user)
activate Service
Service -> Repo: findSeatMapsByName(query, userId)
activate Repo
Repo -> MongoDB: Regex search on name field
MongoDB --> Repo: Matching seat maps
deactivate Repo
Service --> Actions: Filtered seat maps
deactivate Service

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Update displayed seat maps

deactivate Page

@enduml

@startuml view-online-templates
autonumber
!theme plain
title View Online Templates Flow

actor Organizer
participant "Seat Map Directory Page\n(UI Components)" as Page
participant "API Actions" as Actions
participant "Auth Service" as Auth
participant "SeatMap Service" as Service
participant "SeatMap Repository" as Repo
participant "MongoDB" as MongoDB

== Navigate to Templates ==
Organizer -> Page: Click "Browse Templates"
Page -> Actions: getPublicSeatMapsAction(page=1, limit=50)
activate Actions

Actions -> Auth: getAuthSession()
activate Auth
Auth --> Actions: Session with user data
deactivate Auth

Actions -> Service: getPublicSeatMaps(page, limit, searchQuery)
activate Service

Service -> Repo: findSeatMapsWithPagination()
activate Repo

Repo -> MongoDB: Query public seat maps with aggregation
activate MongoDB
Note right of MongoDB
  Query criteria:
  - publicity: "public"
  - Sort by updatedAt DESC
  - Aggregate draft counts
end note

MongoDB --> Repo: Public seat maps with draft counts
deactivate MongoDB

Repo --> Service: Paginated results
deactivate Repo

Service --> Actions: { seatMaps, pagination }
deactivate Service

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Display public templates
Page -> Organizer: Show draft counts and badges

== Search Templates ==
Organizer -> Page: Type in search box
Page -> Actions: getPublicSeatMapsAction(1, 50, query)
activate Actions

Actions -> Service: getPublicSeatMaps(page, limit, query)
activate Service

Service -> Repo: findSeatMapsWithPagination(page, limit)
activate Repo

Repo -> MongoDB: Search with name regex filter
activate MongoDB
MongoDB --> Repo: Matching public seat maps
deactivate MongoDB

Repo --> Service: Filtered results
deactivate Repo
Service --> Actions: Search results
deactivate Service
Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Update displayed templates

@enduml

@startuml create-empty-seat-map
autonumber
!theme plain
title Create Empty Seat Map Flow

actor Organizer
participant "Seat Map Canvas Page\n(UI Components)" as Page
participant "API Actions" as Actions
participant "Auth Service" as Auth
participant "SeatMap Service" as Service
participant "SeatMap Repository" as Repo
participant "Cloudinary" as Cloud
participant "MongoDB" as MongoDB

Organizer -> Page: Click "Create New"
Page -> Page: Initialize empty canvas

Organizer -> Page: Draw shapes and configure seats
Page -> Page: Update canvas state

Organizer -> Page: Click "Upload" and enter name
Page -> Page: Capture canvas as image
activate Page
Page -> Cloud: uploadBlobToCloudinary(blob, filename)
activate Cloud
Cloud --> Page: { secure_url, public_id }
deactivate Cloud
deactivate Page

Page -> Actions: saveSeatMapAction(shapes, name, imageUrl)
activate Actions

Actions -> Auth: getAuthSession()
activate Auth
Auth --> Actions: Session with user data
deactivate Auth

Actions -> Service: saveSeatMap(shapes, name, imageUrl, user)
activate Service

Service -> Repo: createSeatMap(seatMapData)
activate Repo
Repo -> MongoDB: Create seat map document
activate MongoDB
MongoDB --> Repo: Created seat map
deactivate MongoDB
Repo --> Service: Seat map object
deactivate Repo

Service --> Actions: Created seat map
deactivate Service

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Show success message
Page -> Organizer: Navigate to seat maps directory

@enduml

@startuml create-draft-from-template
autonumber
!theme plain
title Draft Online Template Flow

actor Organizer
participant "Seat Map Directory Page\n(UI Components)" as Page
participant "API Actions" as Actions
participant "SeatMap Service" as Service
participant "SeatMap Repository" as Repo
participant "MongoDB" as MongoDB

Organizer -> Page: Browse public templates
Page -> Actions: getPublicSeatMapsAction()
activate Actions

Actions -> Repo: findSeatMapsWithPagination()
activate Repo
Repo -> MongoDB: Query public seat maps
activate MongoDB
MongoDB --> Repo: Public seat maps list
deactivate MongoDB
Repo --> Actions: Public seat maps
deactivate Repo
Actions --> Page: Public templates
deactivate Actions

Page -> Organizer: Display public templates

Organizer -> Page: Click "Use as Template"
Page -> Actions: createDraftFromPublicSeatMapAction(originalId, draftName)
activate Actions

Actions -> Service: createSeatMapDraft(originalId, draftName, user)
activate Service

Service -> Repo: findSeatMapById(originalId)
activate Repo
Repo -> MongoDB: Find original seat map
MongoDB --> Repo: Original seat map data
deactivate Repo

Service -> Repo: createSeatMap(draftData)
activate Repo
Repo -> MongoDB: Create new seat map as draft
activate MongoDB
Note right of MongoDB
  Draft document:
  - shapes: copied from original
  - name: "${originalName} (draft)"
  - createdBy: current user
  - draftedFrom: original ID
  - publicity: "private"
end note
MongoDB --> Repo: Draft created
deactivate MongoDB
Repo --> Service: Draft seat map
deactivate Repo

Service --> Actions: Created draft
deactivate Service

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Show success message
Page -> Organizer: Display updated drafts list

@enduml

@startuml edit-existing-seat-map
autonumber
!theme plain
title Edit Existing Seat Map Flow

actor Organizer
participant "Seat Map Canvas Page\n(UI Components)" as Page
participant "API Actions" as Actions
participant "SeatMap Repository" as Repo
participant "Cloudinary" as Cloud
participant "MongoDB" as MongoDB

Organizer -> Page: Navigate to /seat-map?id={seatMapId}

Page -> Actions: loadSeatMapAction(seatMapId)
activate Actions

Actions -> Repo: findSeatMapById(seatMapId)
activate Repo
Repo -> MongoDB: Find seat map by ID
activate MongoDB
MongoDB --> Repo: Seat map data with shapes
deactivate MongoDB
Repo --> Actions: Seat map data
deactivate Repo

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Display seat map on canvas

Organizer -> Page: Modify shapes and seats
Page -> Page: Update canvas state

Organizer -> Page: Click "Save"
Page -> Page: Capture updated canvas as image
activate Page
Page -> Cloud: uploadBlobToCloudinary(blob, filename)
activate Cloud
Cloud --> Page: { secure_url }
deactivate Cloud
deactivate Page

Page -> Actions: updateSeatMapAction(seatMapId, shapes, imageUrl)
activate Actions

Actions -> Repo: updateSeatMapById(seatMapId, data)
activate Repo
Repo -> MongoDB: Update document
activate MongoDB
MongoDB --> Repo: Updated seat map
deactivate MongoDB
Repo --> Actions: Updated seat map
deactivate Repo

Actions --> Page: { success: true, data }
deactivate Actions

Page -> Organizer: Show success message

@enduml

@startuml cloudinary-image-handling
autonumber
!theme plain
title Cloudinary Image Upload & Management

participant "Seat Map Canvas Page\n(UI Components)" as Page
participant "Cloudinary API" as Cloudinary
participant "MongoDB" as MongoDB

== New Seat Map Upload ==
Page -> Page: Capture canvas as optimized image
Page -> Cloudinary: POST /image/upload
activate Cloudinary
Note right of Cloudinary
  folder: seat-maps
  transformation: auto-optimize
end note
Cloudinary --> Page: { secure_url, public_id }
deactivate Cloudinary

Page -> MongoDB: Save seat map with image URL
MongoDB -> MongoDB: Store secure_url in image field

== Edit Existing Seat Map ==
Page -> Page: Capture updated canvas
Page -> Cloudinary: POST /image/upload (overwrite)
activate Cloudinary
Note right of Cloudinary
  Uses same public_id
  to replace existing image
end note
Cloudinary --> Page: { secure_url }
deactivate Cloudinary

Page -> MongoDB: Update seat map with new image URL

== Image Optimization ==
Note over Page
  Canvas optimizations:
  - High quality export
  - PNG format for transparency
  - Background padding
end note

Note over Cloudinary
  Auto-transformations:
  - f_auto (format)
  - q_auto (quality)
  - Responsive delivery
end note

@enduml