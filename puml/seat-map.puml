@startuml create-new-seat-map
!theme plain
title Create New Seat Map Flow

actor Organizer
participant "Directory Component" as Directory
participant "Canvas Component" as Canvas
participant "Toolbar Component" as Toolbar
participant "State Store" as Store
participant "Session Storage" as Session
participant "API Actions" as Actions
participant "Auth Service" as Auth
participant "SeatMap Service" as Service
participant "SeatMap Repository" as Repo
participant "Cloudinary" as Cloud
participant "MongoDB" as MongoDB

Organizer -> Directory: Click "Create New"
Directory -> Canvas: Navigate to /seat-map

Canvas -> Store: clearStorage()
Canvas -> Store: setCurrentSeatMapId(null)
Canvas -> Session: Remove stored state
Note right of Canvas: Fresh canvas for new seat map

Organizer -> Canvas: Draw shapes (polygons, rectangles, circles)
Canvas -> Store: addShape(shape)
Store -> Store: saveToHistory()
Store -> Session: Debounced save to sessionStorage

Organizer -> Canvas: Enter area mode on polygon
Canvas -> Store: enterAreaMode(polygon)
Store -> Store: Add rows and seats to polygon

Organizer -> Toolbar: Click "Upload" (File menu)
Toolbar -> Toolbar: Open upload dialog

Organizer -> Toolbar: Enter seat map name
Organizer -> Toolbar: Click "Upload"

Toolbar -> Toolbar: setIsUploading(true)
Toolbar -> Canvas: captureSeatMapImageOptimized()
activate Canvas
Canvas -> Canvas: Export stage as optimized image blob
Canvas --> Toolbar: Image blob
deactivate Canvas

Toolbar -> Cloud: uploadBlobToCloudinary(blob, filename)
activate Cloud
Cloud --> Toolbar: { secure_url, public_id }
deactivate Cloud

Toolbar -> Actions: saveSeatMapAction(shapes, name, imageUrl)
activate Actions

Actions -> Auth: getAuthSession()
activate Auth
Auth --> Actions: Session with user data
deactivate Auth

Actions -> Service: saveSeatMap(shapes, name, imageUrl, user)
activate Service

Service -> Service: Validate user role (organizer only)
Service -> Service: Validate input data
Service -> Repo: createSeatMap(seatMapData)
activate Repo
Repo -> MongoDB: SeatMapModel.create(data)
activate MongoDB
MongoDB --> Repo: Created seat map document
deactivate MongoDB
Repo --> Service: Plain seat map object
deactivate Repo

Service --> Actions: Created seat map
deactivate Service

Actions --> Toolbar: { success: true, data }
deactivate Actions

Toolbar -> Store: clearStorage()
Toolbar -> Directory: Navigate to /organizer/seat-map
Toolbar -> Toolbar: toast.success("Uploaded successfully!")

@enduml

@startuml create-draft-from-template
!theme plain
title Create Draft from Public Seat Map Template

actor Organizer
participant "Templates Component" as Templates
participant "API Actions" as Actions
participant "MongoDB" as MongoDB
participant "Canvas Component" as Canvas

Organizer -> Templates: Browse public templates
Templates -> Actions: getPublicSeatMapsAction()
activate Actions

Actions -> MongoDB: Query public seat maps
activate MongoDB
MongoDB --> Actions: Public seat maps list
deactivate MongoDB

Actions --> Templates: Public seat maps with draft counts
deactivate Actions

Organizer -> Templates: Click "Use as Template" on seat map
Templates -> Actions: createDraftFromPublicSeatMapAction(originalId, draftName)
activate Actions

Actions -> MongoDB: Find original seat map by ID
activate MongoDB
MongoDB --> Actions: Original seat map data
deactivate MongoDB

Actions -> Actions: Validate original is public
Actions -> MongoDB: Create new seat map as draft
activate MongoDB
Note right of MongoDB
  New document with:
  - shapes: copied from original
  - name: "${originalName} (draft)"
  - createdBy: current user
  - draftedFrom: original seat map ID
  - originalCreator: original creator info
  - publicity: "private"
end note
MongoDB --> Actions: Draft seat map created
deactivate MongoDB

Actions --> Templates: { success: true, data }
deactivate Actions

Templates -> Templates: toast.success("Draft created!")
Templates -> Templates: Navigate to drafts view
Templates -> Templates: Refresh drafts list

alt Organizer wants to edit the draft
    Organizer -> Templates: Click "Edit" on draft
    Templates -> Canvas: Navigate to /seat-map?id=draftId
    
    Canvas -> Canvas: Load draft data into Canvas
end

@enduml

@startuml edit-existing-seat-map
!theme plain
title Edit Existing Seat Map Flow

actor Organizer
participant "Canvas Component" as Canvas
participant "State Store" as Store
participant "Session Storage" as Session
participant "Toolbar Component" as Toolbar
participant "API Actions" as Actions
participant "MongoDB" as MongoDB
participant "Cloudinary" as Cloud

Organizer -> Canvas: Navigate to /seat-map?id={seatMapId}

Canvas -> Session: Check sessionStorage for existing state

alt Session has matching seat map ID
    Canvas -> Store: loadFromStorage()
    Store -> Session: Restore shapes, history, currentSeatMapId
    Canvas -> Canvas: toast.info("Restored from session")
else No session or different seat map
    Canvas -> Actions: loadSeatMapAction(seatMapId)
    activate Actions
    
    Actions -> MongoDB: Find seat map by ID
    activate MongoDB
    MongoDB --> Actions: Seat map data with shapes
    deactivate MongoDB
    
    Actions --> Canvas: { success: true, data }
    deactivate Actions
    
    Canvas -> Store: loadSeatMapData(seatMapData)
    Store -> Store: Set shapes, history, currentSeatMapId
    Store -> Session: Save to sessionStorage
end

Organizer -> Canvas: Modify shapes, add/remove elements
Canvas -> Store: updateShape(), addShape(), deleteShape()
Store -> Store: saveToHistory()
Store -> Session: Debounced save state

Organizer -> Toolbar: Click "Save"
Toolbar -> Toolbar: setIsSaving(true)

Toolbar -> Canvas: captureSeatMapImageOptimized()
activate Canvas
Canvas -> Canvas: Export current canvas state as image
Canvas --> Toolbar: Updated image blob
deactivate Canvas

Toolbar -> Cloud: uploadBlobToCloudinary(blob, filename)
activate Cloud
Cloud --> Toolbar: { secure_url }
deactivate Cloud

Toolbar -> Actions: updateSeatMapAction(seatMapId, shapes, imageUrl)
activate Actions

Actions -> MongoDB: Update document with new shapes and image
activate MongoDB
MongoDB --> Actions: Updated seat map
deactivate MongoDB

Actions --> Toolbar: { success: true, data }
deactivate Actions

Toolbar -> Toolbar: toast.success("Saved successfully!")
Toolbar -> Toolbar: setIsSaving(false)

@enduml

@startuml seat-map-state-management
!theme plain
title Seat Map State Management & Persistence

participant "Browser Tab" as Browser
participant "Canvas Component" as Canvas
participant "State Persistence" as Persistence
participant "State Store" as Store
participant "Session Storage" as Session
participant "API Actions" as Actions
participant "MongoDB" as MongoDB

== Page Load with Seat Map ID ==
Browser -> Canvas: Navigate to /seat-map?id=123
Canvas -> Persistence: useEffect triggered
Persistence -> Session: Check sessionStorage

alt Session has matching seat map ID
    Session --> Persistence: Found state for seatMapId=123
    Persistence -> Store: loadFromStorage()
    Store -> Store: Restore shapes, history, currentSeatMapId
    Note right of Store: Quick restoration from session
else No session or different seat map
    Persistence -> Actions: loadSeatMapAction(seatMapId)
    activate Actions
    Actions -> MongoDB: Fetch seat map data
    MongoDB --> Actions: Seat map with shapes
    Actions --> Persistence: Seat map data
    deactivate Actions
    
    Persistence -> Store: loadSeatMapData(data)
    Store -> Store: Set shapes, history, currentSeatMapId=123
    Store -> Session: Save initial state
end

== Continuous Editing ==
loop User edits canvas
    Browser -> Store: User actions (add, modify, delete shapes)
    Store -> Store: Update shapes array
    Store -> Store: saveToHistory()
    Store -> Session: Debounced save (1 second delay)
    Note right of Session: State persisted with currentSeatMapId
end

== Page Refresh/Navigation ==
Browser -> Canvas: Refresh or navigate back
Canvas -> Persistence: Check URL for seatMapId
alt Same seat map ID in URL and session
    Persistence -> Store: loadFromStorage()
    Note right of Store: Instant restoration of work
else Different or no seat map ID
    Persistence -> Store: clearStorage()
    Note right of Store: Clean slate for new work
end

== Save Operation ==
Browser -> Store: User clicks save
Store -> Session: forceStorageSave()
Store -> Actions: updateSeatMapAction()
Actions -> MongoDB: Update seat map
Note right of Session: Session state remains for continued editing

@enduml

@startuml cloudinary-image-handling
!theme plain
title Cloudinary Image Upload & Management

participant "Toolbar Component" as Toolbar
participant "Image Capture Function" as Capture
participant "Rendering Engine" as Renderer
participant "Upload Function" as Upload
participant "Cloudinary API" as Cloudinary
participant "MongoDB" as MongoDB

== New Seat Map Upload ==
Toolbar -> Capture: captureSeatMapImageOptimized(stage, shapes)
activate Capture
Capture -> Renderer: Export as high-quality image
Renderer --> Capture: Image blob (optimized)
deactivate Capture

Toolbar -> Upload: uploadBlobToCloudinary(blob, filename, "seat-maps")
activate Upload
Upload -> Cloudinary: POST /image/upload
Note right of Cloudinary
  public_id: auto-generated
  folder: seat-maps
  transformation: auto-optimize
end note
Cloudinary --> Upload: { secure_url, public_id }
deactivate Upload

Toolbar -> MongoDB: Save seat map with image URL
MongoDB -> MongoDB: Store secure_url in image field

== Edit Existing Seat Map ==
Toolbar -> Capture: captureSeatMapImageOptimized(stage, shapes)
activate Capture
Capture -> Renderer: Export updated canvas
Renderer --> Capture: Updated image blob
deactivate Capture

Toolbar -> Upload: uploadBlobToCloudinary(blob, same_filename)
activate Upload
Note right of Upload: Uses same public_id to overwrite
Upload -> Cloudinary: POST /image/upload (overwrite)
Cloudinary --> Upload: { secure_url } (same public_id)
deactivate Upload

Toolbar -> MongoDB: Update seat map with new image URL
Note right of MongoDB: Image URL updated, old image replaced

== Draft Creation ==
Note over MongoDB: Draft copies original image URL initially
Note over Cloudinary: No immediate upload needed
Note over Toolbar: User can edit and save to update image later

== Image Optimization ==
Note over Capture
  Optimizations applied:
  - Canvas scaling for quality
  - Compression for file size
  - PNG format for transparency
  - Background padding
end note

Note over Cloudinary
  Auto-transformations:
  - f_auto (format optimization)
  - q_auto (quality optimization)
  - Responsive delivery
end note

@enduml
@enduml
